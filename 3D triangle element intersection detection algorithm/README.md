## 三维三角形单元交叉判定算法
图片。

不失一般性，设拟相交判断的2个三角面片为T1（A1B1C1）和T2（A2B2C2），T1的3个顶点分别为A1、B1和C1，所在平面为π1，法向量为n1; T2的3个顶点分别为A2、B2和C2，所在平面为π2，法向量为n2。

(1)计算T1各顶点与π1的关系及T2各顶点与π2的关系，排除不相交情况。总流程的伪代码为:<br>
if(A1、B1和C1在π2同侧或A2、B2和C2在π1同侧)<br>
如：判断T2的3个顶点是否在平面π1同侧，建立表达式：t1=A1A2⋅n1,t2=A1B2⋅n1,t3=A1C2⋅n1.如果t1、t2和t3同号且都不为零，则三角面片T1和T2不相交。（有可能有一两个为0，其余同号，此时T1和T2可能不相交、相交、平行不相交，但一定异面，可在后面检测出）<br>
else<br>
&nbsp;&nbsp;&nbsp;&nbsp;if(n1与n2平行，且T2任一顶点在π1上)<br>
&nbsp;&nbsp;&nbsp;&nbsp;判定T1、T2共面，goto(2)；如果f=n1×n2=0，T1与T2是否平行(或共面)需要继续判断T2的任一顶点是否在π1上，即式(1) 中t1、t2和t3为0，则T1和T2共面；不在就T1和T2不相交<br>
&nbsp;&nbsp;&nbsp;&nbsp;else<br>
&nbsp;&nbsp;&nbsp;&nbsp;判定T1、T2异面，goto(3)；如果f的计算结果不为0，则三角面片T1和T2异面<br>
&nbsp;&nbsp;&nbsp;&nbsp;end if<br>
end if<br>

(2)当T1、T2共面时，用python的shapely库（可判断二维三角形相交）判断T1和T2是否相交<br>

(3)当T1、T2异面时，分别判断线段A1B1、B1C1、C1A1是否与三角面片T2相交，以及线段A2B2、B2C2、C2A2和三角面片是否与T1相交，如果以上判断结果均为否，则三角面片T1和T2不相交；如果以上判断结果有一个为真，则三角面片T1和T2相交。<br>
以判断T2的边A2B2是否与三角面片T1相交为例：S1=A1A2·n1，S2=A1B2·n1.当S1=S2=0时，线段A2B2与T1共面；否则A2B2与T1异面。以下从2种情况进行讨论：<br>
1)异面。由于A2B2与T1异面，首先计算(S1·S2)，倘若结果为正，则A2B2在π1同侧，判定A2B2不与T1相交；否则A2、B2在π1异侧且A2和B2至少有一点不在平面π1上。假设A2不在π1上。建立表达式：<br>
g1=[A1B2⋅(A1B1×A1A2)]⋅[A1C1⋅(A1B1×A1A2)]<br>
g2=[B1B2⋅(B1C1×B1A2)]⋅[B1A1⋅(B1C1×B1A2)]<br>
g3=[C1B2⋅(C1A1×C1A2)]⋅[C1B1⋅(C1A1×C1A2)]<br>
如果g1、g2和g3计算结果中存在小于0的情况，则线段A2B2与三角面片T1不相交；如果3个结果均为非负，则线段A2B2与三角面片T1相交<br>
2)共面。如果A2B2与T1共面，用python的shapely库判断T1和A2B2是否相交<br>
如果A2B2与T1共面，首先运用前述方法判断A2、B2是否在T1内，若至少存在一点在T1内，则线段A2B2与T1相交；若A2、B2都不在T1内，只有2种情况：A2B2与T1不相交和A2B2与T1共面相交。此时如果A2B2与T1共面相交，T1中必定存在边与T2异面相交，由于T1、T2的每一条边都要作相交判断，所以当A2、B2都不在T1内，算法中可认定为不相交或不作处理，不影响T1、T2相交判定最终结果。


## 有限元单元合法性检测
。

程序**check_inp.ipynb**以读入**p.inp**为例进行检测：<br>
（inp为ABAQUS的模型文件，包含三角形有限单元顶点编号及坐标，具体格式请参见官方文档）

1.对顶点坐标、编号和面编号、三顶点编号的唯一性、范围进行检测，inp文件不需满足编号连续性，对重复的应进行删除或重编号

2.统计单元边的共享单元数，对于有限元模型，任何一条边都应被有且只有两个单元共享。此模型出现了四个单元共享一条边的几何错误，这里将该边平移少许距离作为第二条新边，其中两个单元随其移动，定义并更新相应坐标和编号。

3.最后检测三维三角形单元是否交叉，对于有共享顶点的两单元，判断该点对边是否与另一单元相交，方法见后，若不相交则是正常情况不考虑；而对于有共享边的两单元，若其相对顶点在另一单元所在平面内且与另一相对顶点在共享边同侧，则为异常交叉情况；对于其他情况，则用上诉通用的三维三角形相交算法

在实验过程中，numpy及python默认小数类型在进行向量叉积、点积计算时不满足精度要求，导致程序误判，因此换成sympy中的有理数类型表示一切小数，但是大大增加了运行时间，一共运行了近两天，最后发现整个模型共四处交叉异常情况，这里将每一处嵌入的点坐标进行微调，使其满足有限单元要求。

**python requirements: shapely, sympy**
